---
title: Average treatment effect of cholesterol-lowering medication and average systolic blood pressure (SBP), mm Hg.

author: 
- name: Jackson Gazin
  affiliation: Department of Statistics, Wake Forest University
  email: gazij22@wfu.edu
  
- name: Ashley Mullan
  affiliation: Department of Statistics, Wake Forest University
  email: mullae22@wfu.edu
  
- name: Anh Nguyen
  affiliation: Department of Statistics, Wake Forest University
  email: nguyp22@wfu.edu

keywords:
- cholesterol-lowering medication,
- systolic blood pressure,
- blood pressure control

abstract: |
  We investigate the average treatment effect among the treated (ATT) of cholesterol-lowering medication on the mean systolic blood pressure (mm Hg). Using data from the National Health and Nutrition Examination Survey (NHANES), we fit a propensity score model to estimate the ATT among adults living in the United States of America. 

bibliography: bibliography.bib
output: rticles::biometrics_article
month: "`r format(Sys.Date(), '%b')`"
year: "`r format(Sys.Date(), '%Y')`"
referee: true # Papers submitted to Biometrics should ALWAYS be prepared
              # using the referee option!!!! Turn off only to preview
              # two column-format
---

```{r include=FALSE}
#| label: load-pkgs
#| message: false
#| warning: false
# tidyverse
library(tidyverse)
# dag
library(ggdag)
# eda
library(skimr)
library(visdat)
# plot
library(halfmoon)
# table 
library(gtsummary)
library(labelled)
library(broom)
library(survey)
# propensity
library(propensity)
# adjusting SEs
library(rsample)
library(sandwich)
# sensitivity
library(tipr)
# data
library(cardioStatsUSA)
data("nhanes_data")
```

```{r include=FALSE}
nhanes_data_selected <- nhanes_data |> 
  mutate(log_age = log(demo_age_years)) |>
  select(chol_med_use, chol_total, bp_sys_mean, bp_med_use, cc_bmi, log_age, demo_race, demo_gender, demo_age_years)
```


# Introduction {#intro}

__overview of bp control and motivate why we need to control it__

Controlling blood pressure (BP) reduces the risk for cardiovascular disease. However, the prevalence of BP control (i.e., systolic BP < 140 and diastolic BP < 90) among US adults with hypertension has decreased since 2013. 

__why we are looking at cholesterol-lowering medication as an exposure__

High blood pressure (hypertension) and high cholesterol are linked. Cholesterol plaque and calcium cause your arteries to become hard and narrow. So, your heart has to strain much harder to pump blood through them. As a result, your blood pressure becomes too high. 

The prescription of both antihypertensive and cholesterol-lowering drugs is generally required for these patients. Doctors often prescribe statin drugs like atorvastatin (Lipitor), rosuvastatin (Crestor, Ezallor) and simvastatin (Zocor, FloLipid) for patients with high cholesterol.

Under the current guidelines:

Normal: Less than 120/80
Elevated: Systolic between 120-129 and diastolic less than 80
Stage 1 hypertension: Systolic between 130-139 or diastolic between 80-89


Statin (a chemical in cholesterol-lowering medication) have been proven to be effective in minimizing the risk of cardiovascular adverse events. Statins block a substance the liver needs to make cholesterol. Thus statins have the potential to lower blood pressure (BP). In many cases, simultaneously lower blood pressure and cholesterol level



__other studies that have look at the same thing__

__explain our dags and why we include thing__

__add short summary of methods here__

Using a causal analysis approach, we aim to explore whether taking cholesterol-lowering medication have the potential to lower blood pressure. By analyzing the publicly available National Health and Nutrition Examination Survey (NHANES), we will estimate the average treatment effect among those who take  cholesterol-lowering medication. Our primary outcome is mean systolic blood pressure (DBP).

__add short summary of results here__

# Materials and methods {#methods}

## Data

The National Health and Nutrition Examination Survey (NHANES) combines interviews and physical examinations to assess the health and nutritional status of adults and children in the United States of America. The program started in the early 1960s and has been conducted every two years since 1999. The survey samples from a nationally representative 5,000 persons each year. The participants are located in counties across the country, 15 of which are visited each year. The interview asks questions about demographic, socioeconomic, dietary, and health-related questions. The examination consists of medical, dental, physiological measurements, and laboratory tests.

The NHANES dataset we are using can be downloaded from __cite__ . The dataset contains information from the survey from 1999 to 2020 with a sample of 59,799 rows and 111 chosen columns. Each row is a noninstitutionalized US adults participated in the survey between 1999 and 2020. Tahe columns contain information about demographics, blood pressure levels, hypertension status, antihypertensive medication usage, and co-morbidities. 

For this analysis, we had 38977 rows with NA values. We decided to deal with this by removing all the na values. We decided this was preferable to removing certain columns since we were still left with 20,822 data points which is still an extremely large data set. 

```{r fig_vizmis, fig.width = 4, fig.height = 4, fig.cap = "Missing data percentage for selected variables", echo = FALSE, dev = "pdf"}
vis_miss(nhanes_data_selected)
```


## Statistical methods

We fitted a propensity score model with "Total cholesterol" in mg/dL as our explanatory variable since this was the only variable, and "taking cholesterol medication" as our response variable, as it represents our exposure variable. We employed a Logistic Regression model for the propensity score model.

Subsequently, we used the propensity score model to fit our outcome model, estimating the average treatment effect among the treated. We utilized a linear regression model with "cholesterol medication" as our explanatory variable and "Systolic blood pressure (SBP)" in mm Hg as our response variable.

To assess the appropriateness of our propensity score model and proceed with our final model, we employed weighted mirrored histograms, ECDF plots, and Love Plots.

### Causal directed acyclic graphs

We visualize the assumptions that weâ€™re making about the causal relationships between the use of cholesterol-lowering medication (the exposure), the mean systolic blood pressure (the outcome), and other possible confounders in the data set.

```{r fig_dag, fig.width = 4, fig.height = 4, fig.cap = "Causal direct acyclic graph between cholesterol-lowering medication and the mean systolic blood pressure", echo = FALSE, dev = "pdf"}
dag <- dagify(
  bp_sys_mean ~ bp_med_use + cc_smoke + cc_bmi + chol_total + demographics + chol_med_use, 
  bp_med_use ~ bp_sys_mean,
  cc_smoke ~ demographics,
  cc_bmi ~ demographics,
  chol_total ~ cc_bmi + demographics,
  chol_med_use ~ chol_total,
  exposure = "chol_med_use",
  outcome = "bp_sys_mean",
  labels = c(
    bp_sys_mean = "systolic blood pressure",
    bp_med_use = "antihypertensive medication",
    cc_smoke = "smoking",
    cc_bmi = "bmi",
    chol_total = "total cholesterol",
    demographics = "demographics",
    chol_med_use = "cholesterol-lowering medication"
  )
)

ggdag(dag, use_labels = "label", text = FALSE) +
  theme_dag()
```

Given our assumptions, we need to adjust for the following adjustment set. The adjustment is given in Figure \@ref(fig:fig_adjustment).

```{r fig_adjustment, fig.width = 4, fig.height = 4, fig.cap = "Causal adjustment set", echo = FALSE, dev = "pdf"}
ggdag_adjustment_set(
  dag,
  use_labels = "label",
  text = FALSE
)
```

### Exploratory data analysis

```{r}
nhanes_data |> 
  drop_na() |>
  ggplot(aes(fill = chol_med_use, x = bp_sys_mean)) +
  geom_mirror_histogram()
```

### Modeling

# Results {$results}

## Study population

We aim answer our causal question by fitting an average treatment effect among the treated. Our causal question is as follows: Among those who take cholesterol lowering medication, does taking this cholesterol lowering medication change their systolic blood pressure?

```{r tab_pop, message=FALSE, warning=FALSE}
nhanes_data_selected |>
  select(-c(log_age)) |>
  tbl_summary(
    by = chol_med_use) |>
  # add an overall column to the table
  add_overall(last = TRUE)
```


## Propensity score model and Diagnostics 

We fitted a propensity score model with "total cholesterol" in mg/dL as our explanatory variable and "taking cholesterol medication" as our response variable. We employed a Logistic Regression model for this purpose. Subsequently, we examined a Mirrored Histogram of our propensity scores for both exposure groups. The table below demonstrates significant overlap in propensity scores across both groups, indicating very little evidence of a positivity violation in our model, which is promising.

Next, we used our propensity score model to generate weights for the average treatment effect among the treated (ATT), aligning with our causal question. To assess the appropriateness of our propensity score model and the resulting weights, we created a Weighted Mirror Histogram of our propensity scores. As shown below, we achieved sufficient balance between the exposed and unexposed groups. Furthermore, the distribution of the unexposed group now resembles that of the exposed group, which is the desired outcome when using ATT weights.

We also generated a love plot, displaying the standardized mean difference changes for the exposed and unexposed groups regarding our "total cholesterol" variable in both unweighted and weighted data. As expected, our weighted data exhibit a standardized mean difference of 0 for the "total cholesterol" variable, which is ideal and allows us to proceed.

Finally, we created a weighted empirical cumulative distribution function (eCDF) plot for our continuous variable, "total cholesterol." As shown below, the Weighted ECDF plot indicates balance not only in the mean across exposure groups but also across their respective distributions. No changes are required for our model, and we can now proceed to estimate our average treatment effect among the treated.

```{r message=FALSE, warning=FALSE}
#check the vibes to think about an estimator
data <- nhanes_data |> 
  as.data.frame() |> 
  drop_na() |>
  mutate(log_age = log(demo_age_years)) |>
  select(chol_med_use, chol_total, bp_sys_mean, bp_med_use, cc_bmi, log_age, demo_race, demo_gender)

prop <- glm(chol_med_use ~ chol_total + bp_med_use + cc_bmi + log_age + demo_race + demo_gender, 
    data = data,
    family = binomial())
data <- prop |> 
  augment(type.predict = "response", data = data)  |>
  select(-c(.resid, .hat, .sigma, .cooksd, .std.resid)) |>
  rename("prop" = ".fitted")
data <- data |>
  mutate(w_att = wt_att(prop, chol_med_use)) 

```

### Diagnostics

```{r}
data |> 
  ggplot(aes(x = prop, 
             group = chol_med_use, 
             fill = chol_med_use)) +
  geom_mirror_histogram(bins = 20) +
  theme_bw() +
  labs(x = "Propensity Score",
       y = "Count",
       fill = "Uses Cholesterol Medication?",
       title = "no positivity violations!",
       subtitle = "(no weighting)") +
  scale_fill_manual(values = c("blue", "magenta"))
```


```{r}
data |>
  ggplot(aes(x = prop, fill = chol_med_use)) +
  geom_mirror_histogram(
    aes(fill = chol_med_use,
        weight = w_att),
    binwidth = 0.05) +
  scale_fill_manual(values = c("#006241", "#cba258")) +
  scale_y_continuous(labels = abs) +
  theme_bw() +
  labs(x = "Propensity Score",
       fill = "Uses Cholesterol Medication?",
       y = "Count",
       title = "Weighted Sample Distributions",
       subtitle = "ATT Weighting")
```

```{r}
smds <- tidy_smd(
  data,
  .vars = c(chol_total, bp_med_use, cc_bmi, log_age, demo_race, demo_gender),
  .group = chol_med_use,
  .wts = w_att
)

smds |>
  ggplot(aes(x = abs(smd), y = variable,
             group = method, color = method)) +
  geom_love() + 
  theme_bw() +
  labs(title = "Love Plot: Examining SMDs")
```


```{r}
data |>
  ggplot(aes(x = chol_total, color = chol_med_use)) +
  geom_ecdf(aes(weights = w_att)) +
  scale_color_manual(
    "Uses Cholesterol Medication?",
    values = c("#FF69B4", "#013220"),
    labels = c("Y", "N")) +
    labs(x = "Total Cholesterol", y = "Prop <= X",
           title = "Weighted ECDF") +
  theme_bw() 

data |>
  ggplot(aes(x = chol_total, color = chol_med_use)) +
  geom_ecdf(aes(weights = w_att)) +
  scale_color_manual(
    "Uses Cholesterol Medication?",
    values = c("#FF69B4", "#013220"),
    labels = c("Y", "N")) +
    labs(x = "Total Cholesterol", y = "Prop <= X",
           title = "Weighted ECDF") +
  theme_bw() 
```



## Average treatment effect among the treated

We estimated the average treatment effect of taking cholesterol-lowering medication. Our findings indicate that, on average, individuals who take cholesterol-lowering medication experience an increase of 9.26 mm Hg in their Systolic Blood Pressure (SBP). We are 95 percent confident that the average effect of taking this medication on SBP falls within the range of at least 8.578 mm Hg to at most 9.941 mm Hg. Additionally, we conducted a sensitivity analysis to account for the possibility that our Directed Acyclic Graph (DAG) might not include all potential confounding variables. In this analysis, we calculated the necessary relationship between an unmeasured confounder and the change in weight required to shift the lower bound of the confidence interval to the null hypothesis level (5%). We considered exposure confounder effects of sizes 0.05, 0.10, and 0.15, which would necessitate confounder-outcome effects of 172, 85, and 57, respectively, to influence the interval. The smallest of these values, 57, is over 6 times greater than the estimated treatment effect. Therefore, it is reasonable to conclude that the Average Treatment Effect (ATT) we computed is robust against potential confounding factors.


```{r tab_reg}
outcome_mod <-  lm(bp_sys_mean ~ chol_med_use, data = data, weights = w_att)
robust_var <- sandwich(outcome_mod)[2, 2]
point_est <- coef(outcome_mod)[2]
lb <- round(point_est - 1.96 * sqrt(robust_var),3)
ub <- round(point_est + 1.96 * sqrt(robust_var),3)

paste0("The point estimate for the ATT is ", round(point_est,3), " with 95% CI (", lb, ",", ub,").")
```

## Sensitivity analysis

```{r tab_sensitivity}
tip_coef_with_continuous(
  effect_observed = -2.71, #upper bound of CI
  exposure_confounder_effect = c(0.05, 0.10, 0.15),
  verbose = FALSE
)
```

# Discussion {#discussion}

## Limitation

will make lifestyle changes rather than take medication

not time sensitive

# Supplementary information {#supplement}

The data can be downloaded from GitHub or accessed via the cardioStatsUSA R package. For both the file and information about the R package, see https://github.com/jhs-hwg/cardioStatsUSA.

All code for the analysis can be accessed at __link github__

# Acknowledgement {#acknowledge}

Thank Dr. Lucy D'Agostino McGowan for her guidance and assistance in preparing this manuscript.

# Section title {#sec:1}

Text with citations by @heagerty2000time, [@pepe2003statistical].

## Subsection title {#sec:2}

as required [@hoerl1970ridge; @zou2005regularization]. Don't forget to give each section
and subsection a unique label (see Sect. \ref{sec:1}).

#### Paragraph headings 

Use paragraph headings as needed.

## Equations

Here is an equation:

$$ f_{X}(x) = \left(\frac{\alpha}{\beta}\right)\left(\frac{x}{\beta}\right)^{\alpha-1}e^{-\left(\frac{x}{\beta}\right)^{\alpha}}; \alpha,\beta,x > 0 $$

Here is another:
\begin{align}
a^2+b^2=c^2
\end{align}

Inline equations: $\sum_{i = 2}^\infty\{\alpha_i^\beta\}$

# Figures and tables

## Figures coming from R

#### Normal figure embedded in text

```{r fig2, fig.width = 4, fig.height = 4, fig.cap = "Output from `pdf()`", echo = FALSE, dev = "pdf"}
ggdag(dag, use_labels = "label", text = FALSE) +
  theme_dag()
```

\clearpage

## Tables coming from R


```{r tab1, results = 'asis'}
print(xtable::xtable(head(mtcars)[,1:4], 
caption = "Caption centered under table", label = "tab1"), 
comment = FALSE, timestamp = FALSE, caption.placement = "top")
```

Table \ref{tab1} shows these numbers. Some of those numbers are plotted in Figure \ref{fig:fig1}.


```{r tab2}
head(mtcars[,1:4])
```


# References
